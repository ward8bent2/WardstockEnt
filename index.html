
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WardStock - ระบบจัดการคลังพัสดุ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .view-section { display: none; }
        .view-section.active { display: block; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react/": "https://esm.sh/react@^19.2.4/",
    "@google/genai": "https://esm.sh/@google/genai@^1.40.0",
    "recharts": "https://esm.sh/recharts@^3.7.0"
  }
}
</script>
</head>
<body class="min-h-screen">

    <!-- LOGIN SECTION -->
    <div id="view-login" class="view-section active min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white rounded-[40px] shadow-2xl p-10 border border-gray-100 text-center animate-fadeIn">
            <div class="w-20 h-20 bg-blue-600 text-white rounded-[28px] flex items-center justify-center mx-auto mb-6 shadow-xl shadow-blue-100">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>
            </div>
            <h1 class="text-3xl font-black text-gray-800 tracking-tighter">WardStock</h1>
            <p class="text-gray-400 mt-2 font-bold text-xs uppercase tracking-widest mb-10">Medical Supply Manager</p>
            <div class="space-y-4">
                <button onclick="login('NURSE')" class="w-full py-5 bg-blue-600 hover:bg-blue-700 text-white rounded-3xl font-black transition-all shadow-lg active:scale-95">พยาบาลประจำหอผู้ป่วย</button>
                <button onclick="login('SUPERVISOR')" class="w-full py-5 bg-white border-2 border-gray-100 hover:border-blue-600 rounded-3xl font-black text-gray-700 transition-all active:scale-95">หัวหน้างาน / โลจิสติกส์</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP SECTION -->
    <div id="view-app" class="view-section min-h-screen flex flex-col">
        <!-- Header -->
        <nav class="bg-white border-b border-gray-100 p-4 sticky top-0 z-30 shadow-sm flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-600 text-white p-2 rounded-xl">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2" strokeWidth="2"/></svg>
                </div>
                <span class="text-xl font-black tracking-tighter text-gray-800">WardStock</span>
            </div>
            <div class="flex items-center space-x-3">
                <div class="text-right hidden sm:block">
                    <p id="user-display-name" class="text-xs font-black text-gray-800"></p>
                    <p id="user-display-ward" class="text-[9px] text-gray-400 uppercase font-bold tracking-widest"></p>
                </div>
                <button onclick="logout()" class="p-2 text-rose-500 bg-rose-50 rounded-xl hover:bg-rose-100 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 16l4-4m4 4H7m6 4v1a3 3 0 01-3 3H6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>
                </button>
            </div>
        </nav>

        <!-- Content -->
        <main class="flex-1 p-4 max-w-5xl w-full mx-auto pb-24">
            
            <!-- Dashboard (Supervisor Only) -->
            <div id="page-dashboard" class="page-content space-y-4 hidden animate-fadeIn">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                        <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">พัสดุทั้งหมด</p>
                        <p id="stat-total" class="text-3xl font-black text-gray-800">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                        <p class="text-[10px] font-black text-rose-400 uppercase tracking-widest">สต็อกต่ำ</p>
                        <p id="stat-low" class="text-3xl font-black text-rose-600">0</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                    <h3 class="font-black text-gray-800 mb-4">สถานะสต็อกปัจจุบัน</h3>
                    <div id="stock-list-simple" class="space-y-2"></div>
                </div>
            </div>

            <!-- Usage (Nurse/All) -->
            <div id="page-usage" class="page-content space-y-6 hidden animate-fadeIn">
                <div class="bg-white p-8 rounded-[40px] shadow-xl border border-gray-100">
                    <h2 class="text-2xl font-black mb-6 text-gray-800">บันทึกตัดสต็อก</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-black text-gray-400 uppercase ml-1 tracking-widest">ระบุเตียง/วอร์ด</label>
                            <input id="usage-bed" type="text" placeholder="เช่น Bed 12" class="w-full p-4 bg-gray-50 rounded-2xl border-none outline-none font-bold mt-1 shadow-sm">
                        </div>
                        <div class="border-t pt-4">
                            <p class="text-[10px] font-black text-gray-400 uppercase mb-2 tracking-widest">รายการที่เลือก</p>
                            <div id="selected-items-list" class="space-y-2 mb-4">
                                <p class="text-sm text-gray-300 italic py-2">ยังไม่มีรายการที่เลือก...</p>
                            </div>
                            <button onclick="submitUsage()" class="w-full py-5 bg-blue-600 text-white rounded-3xl font-black shadow-lg shadow-blue-100 active:scale-95 transition-all">ยืนยันการบันทึก</button>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-black text-gray-400 uppercase tracking-widest mb-3 ml-2">เลือกพัสดุ (หรือสแกน)</h3>
                    <div id="item-grid-usage" class="grid grid-cols-2 gap-2"></div>
                </div>
            </div>

            <!-- Logistics (Supervisor Only) -->
            <div id="page-logistics" class="page-content space-y-6 hidden animate-fadeIn">
                <div class="bg-white p-8 rounded-[40px] shadow-xl border border-gray-100">
                    <h2 class="text-2xl font-black mb-6 text-gray-800">รับพัสดุเข้าคลัง</h2>
                    <div class="space-y-4">
                        <select id="intake-item" class="w-full p-4 bg-gray-50 rounded-2xl border-none outline-none font-bold shadow-sm"></select>
                        <input id="intake-qty" type="number" placeholder="จำนวนที่รับเข้า" class="w-full p-4 bg-gray-50 rounded-2xl border-none outline-none font-bold shadow-sm">
                        <button onclick="submitIntake()" class="w-full py-5 bg-emerald-600 text-white rounded-3xl font-black shadow-lg shadow-emerald-100 active:scale-95">บันทึกรับเข้าคลัง</button>
                    </div>
                </div>
            </div>

            <!-- History -->
            <div id="page-history" class="page-content space-y-4 hidden animate-fadeIn">
                <h2 class="text-2xl font-black text-gray-800 px-2">ประวัติย้อนหลัง</h2>
                <div id="history-list" class="space-y-2"></div>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-2 flex justify-around items-center z-40 shadow-[0_-10px_30px_rgba(0,0,0,0.05)]">
            <button id="nav-dashboard" onclick="switchPage('dashboard')" class="flex flex-col items-center p-2 text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>
                <span class="text-[8px] font-black uppercase mt-1">หน้าหลัก</span>
            </button>
            <button id="nav-usage" onclick="switchPage('usage')" class="flex flex-col items-center p-2 text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>
                <span class="text-[8px] font-black uppercase mt-1">ตัดสต็อก</span>
            </button>
            <button id="nav-logistics" onclick="switchPage('logistics')" class="flex flex-col items-center p-2 text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4a2 2 0 012-2m16 0h-2m-8 0H6m4-3l2 2m0 0l2-2m-2 2V3" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>
                <span class="text-[8px] font-black uppercase mt-1">โลจิสติกส์</span>
            </button>
            <button id="nav-history" onclick="switchPage('history')" class="flex flex-col items-center p-2 text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>
                <span class="text-[8px] font-black uppercase mt-1">ประวัติ</span>
            </button>
        </div>
    </div>

    <!-- JS LOGIC -->
    <script>
        // --- DATA & CONFIG ---
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbygNSd3p7EAgEyozjsmPKWvhg0hinh27liBJ6mZqOYNJmmMtcMzLUOBmQbn_jXK2FTW/exec';
        
        let currentUser = null;
        let inventory = JSON.parse(localStorage.getItem('ws_inventory')) || [
            { id: '1', name: 'หน้ากากอนามัย N95', currentStock: 50, minLevel: 20, unit: 'ชิ้น' },
            { id: '2', name: 'ถุงมือยาง Size M', currentStock: 120, minLevel: 50, unit: 'กล่อง' },
            { id: '3', name: 'สายให้น้ำเกลือ (IV Set)', currentStock: 200, minLevel: 100, unit: 'ชุด' },
            { id: '4', name: 'กระบอกฉีดยา 5ml', currentStock: 500, minLevel: 100, unit: 'ชิ้น' },
            { id: '5', name: 'แอลกอฮอล์ 70% 450ml', currentStock: 15, minLevel: 10, unit: 'ขวด' }
        ];
        let transactions = JSON.parse(localStorage.getItem('ws_transactions')) || [];
        let pendingUsage = [];

        // --- CORE FUNCTIONS ---
        function login(role) {
            currentUser = {
                name: role === 'NURSE' ? 'พยาบาลสมหญิง' : 'หัวหน้าสมศรี',
                role: role,
                ward: 'Ward 5A'
            };
            document.getElementById('user-display-name').innerText = currentUser.name;
            document.getElementById('user-display-ward').innerText = currentUser.ward;
            
            document.getElementById('view-login').classList.remove('active');
            document.getElementById('view-app').classList.add('active');

            // UI Control based on role
            if (role === 'NURSE') {
                document.getElementById('nav-dashboard').style.display = 'none';
                document.getElementById('nav-logistics').style.display = 'none';
                switchPage('usage');
            } else {
                document.getElementById('nav-dashboard').style.display = 'flex';
                document.getElementById('nav-logistics').style.display = 'flex';
                switchPage('dashboard');
            }
            
            checkURLParams();
            saveData();
        }

        function logout() {
            currentUser = null;
            document.getElementById('view-app').classList.remove('active');
            document.getElementById('view-login').classList.add('active');
        }

        function switchPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-' + pageId).classList.remove('hidden');

            // Nav Styling
            document.querySelectorAll('button[id^="nav-"]').forEach(btn => {
                btn.classList.remove('text-blue-600');
                btn.classList.add('text-gray-300');
            });
            document.getElementById('nav-' + pageId).classList.add('text-blue-600');
            document.getElementById('nav-' + pageId).classList.remove('text-gray-300');

            renderPage(pageId);
        }

        function renderPage(pageId) {
            if (pageId === 'dashboard') {
                const lowStock = inventory.filter(i => i.currentStock <= i.minLevel);
                document.getElementById('stat-total').innerText = inventory.length;
                document.getElementById('stat-low').innerText = lowStock.length;
                
                let html = '';
                inventory.forEach(item => {
                    const isLow = item.currentStock <= item.minLevel;
                    html += `
                        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-2xl">
                            <span class="font-bold text-gray-700">${item.name}</span>
                            <span class="font-black ${isLow ? 'text-rose-600' : 'text-blue-600'}">${item.currentStock} ${item.unit}</span>
                        </div>
                    `;
                });
                document.getElementById('stock-list-simple').innerHTML = html;
            }

            if (pageId === 'usage') {
                let gridHtml = '';
                inventory.forEach(item => {
                    gridHtml += `
                        <button onclick="addToPending('${item.id}')" class="p-4 bg-white border border-gray-100 rounded-2xl text-left hover:bg-blue-50 transition-colors shadow-sm">
                            <p class="text-[9px] font-black text-blue-500 uppercase tracking-tighter">STOCK: ${item.currentStock}</p>
                            <p class="text-xs font-bold text-gray-700 truncate">${item.name}</p>
                        </button>
                    `;
                });
                document.getElementById('item-grid-usage').innerHTML = gridHtml;
                renderPendingList();
            }

            if (pageId === 'logistics') {
                let options = '<option value="">-- เลือกรายการ --</option>';
                inventory.forEach(item => {
                    options += `<option value="${item.id}">${item.name} (${item.unit})</option>`;
                });
                document.getElementById('intake-item').innerHTML = options;
            }

            if (pageId === 'history') {
                let html = '';
                [...transactions].reverse().slice(0, 20).forEach(t => {
                    const isUsage = t.type === 'USAGE';
                    html += `
                        <div class="p-4 bg-white border border-gray-50 rounded-2xl flex justify-between items-center shadow-sm">
                            <div>
                                <p class="text-xs font-black text-gray-800">${t.itemName}</p>
                                <p class="text-[9px] text-gray-400 font-bold uppercase">${new Date(t.timestamp).toLocaleString('th-TH')}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-black ${isUsage ? 'text-rose-500' : 'text-emerald-500'}">${isUsage ? '-' : '+'}${t.quantity}</p>
                                <p class="text-[9px] text-gray-400 font-bold uppercase">${t.bed || 'คลังกลาง'}</p>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('history-list').innerHTML = html || '<p class="text-center text-gray-300 py-10 italic">ไม่มีประวัติการใช้งาน</p>';
            }
        }

        // --- ACTION FUNCTIONS ---
        function addToPending(itemId) {
            const item = inventory.find(i => i.id === itemId);
            const existing = pendingUsage.find(p => p.itemId === itemId);
            if (existing) {
                existing.quantity++;
            } else {
                pendingUsage.push({ itemId: item.id, itemName: item.name, quantity: 1, unit: item.unit });
            }
            renderPendingList();
        }

        function removeFromPending(itemId) {
            pendingUsage = pendingUsage.filter(p => p.itemId !== itemId);
            renderPendingList();
        }

        function renderPendingList() {
            let html = '';
            pendingUsage.forEach(p => {
                html += `
                    <div class="flex justify-between items-center bg-blue-50 p-3 rounded-xl border border-blue-100">
                        <span class="text-sm font-bold text-blue-800">${p.itemName}</span>
                        <div class="flex items-center space-x-3">
                            <span class="font-black text-blue-600">${p.quantity} ${p.unit}</span>
                            <button onclick="removeFromPending('${p.itemId}')" class="text-rose-400">❌</button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('selected-items-list').innerHTML = html || '<p class="text-sm text-gray-300 italic py-2">ยังไม่มีรายการที่เลือก...</p>';
        }

        async function submitUsage() {
            const bed = document.getElementById('usage-bed').value;
            if (!bed) return alert('กรุณาระบุเลขเตียงหรือวอร์ด');
            if (pendingUsage.length === 0) return alert('กรุณาเลือกพัสดุ');

            for (const p of pendingUsage) {
                const invItem = inventory.find(i => i.id === p.itemId);
                invItem.currentStock -= p.quantity;
                
                const newT = {
                    id: Math.random().toString(36).substr(2, 9),
                    itemId: p.itemId,
                    itemName: p.itemName,
                    type: 'USAGE',
                    quantity: p.quantity,
                    bed: bed,
                    timestamp: new Date().toISOString()
                };
                transactions.push(newT);

                // Send to Sheets
                sendToSheets('outcome', {
                    itemName: p.itemName,
                    amount: p.quantity,
                    unit: p.unit,
                    requester: currentUser.name,
                    remark: 'Bed: ' + bed
                });
            }

            pendingUsage = [];
            document.getElementById('usage-bed').value = '';
            saveData();
            alert('บันทึกข้อมูลเรียบร้อยแล้ว');
            switchPage('usage');
        }

        async function submitIntake() {
            const itemId = document.getElementById('intake-item').value;
            const qty = parseInt(document.getElementById('intake-qty').value);
            if (!itemId || isNaN(qty) || qty <= 0) return alert('กรุณาระบุข้อมูลให้ครบถ้วน');

            const invItem = inventory.find(i => i.id === itemId);
            invItem.currentStock += qty;

            const newT = {
                id: Math.random().toString(36).substr(2, 9),
                itemId: itemId,
                itemName: invItem.name,
                type: 'INTAKE',
                quantity: qty,
                timestamp: new Date().toISOString()
            };
            transactions.push(newT);

            // Send to Sheets
            sendToSheets('income', {
                itemName: invItem.name,
                amount: qty,
                unit: invItem.unit,
                receiver: currentUser.name,
                remark: 'รับเข้าคลังปกติ'
            });

            document.getElementById('intake-qty').value = '';
            saveData();
            alert('บันทึกรับเข้าเรียบร้อย');
            switchPage('dashboard');
        }

        function saveData() {
            localStorage.setItem('ws_inventory', JSON.stringify(inventory));
            localStorage.setItem('ws_transactions', JSON.stringify(transactions));
        }

        async function sendToSheets(action, payload) {
            try {
                // Using no-cors mode for basic GAS interaction
                fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action, ...payload, timestamp: new Date().toISOString() })
                });
                console.log("Sent to GAS:", action, payload);
            } catch (e) { console.error("Sheets Error:", e); }
        }

        function checkURLParams() {
            const params = new URLSearchParams(window.location.search);
            const itemParam = params.get('item');
            if (itemParam && inventory) {
                const found = inventory.find(i => i.name === itemParam);
                if (found) {
                    addToPending(found.id);
                    // Clear param without reload
                    const url = new URL(window.location.href);
                    url.searchParams.delete('item');
                    window.history.replaceState({}, '', url);
                }
            }
        }

        // Auto-check on start if logged in
        window.onload = () => {
            // Optional: Auto-login during development
            // login('NURSE'); 
        };
    </script>
</body>
</html>
